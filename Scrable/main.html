<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrabble solver!</title>
</head>
<body>

    <label for="fname">Letters:</label>
    <input type="text" id="fname" name="fname">
    <button id="search">Search</button>
    <div id="res"></div><h3 id="comp"></h3><h4 id="comb"></h4>
    <h4 id="atrasti"></h4>
    <h4 id="loc"></h4>

    <style>
        * {
            padding: 10px;
            text-align: center;
            margin-top: 15px;
        }

        label {
            font-weight: bold;
        }

        body { 
            background-color: grey;
        }

        h2 {
            color: greenyellow;
            background-color: grey;
        }

        button {
            width: auto;
            height: auto;
        }

        button:hover {
            cursor:pointer;
        }
        
        #search {
            border: none;
            background-color: rgb(248, 255, 185);
        }
        
        
    </style>

    <script>
        let cache = [];

        async function main(word) {
            const res = await fetch("https://api.tezaurs.lv/v1/examples/" + word);
            const json = await res.json();
            return json;
        }

        function factorial(n){
            let answer = 1;
            if (n == 0 || n == 1){
            return answer;
            }else{
            for(var i = n; i >= 1; i--){
                answer = answer * i;
            }
            return answer;
            }  
        }

        function swap(chars, i, j) {
            [chars[i], chars[j]] = [chars[j], chars[i]];
        }


        function getAnagrams(input) {
            var counter = [],
                anagrams = [],
                chars = input.split(''),
                length = chars.length,
                i;

            let removedWords = 0;

            for (i = 0; i < length; i++) {
                counter[i] = 0;
            }

            anagrams.push(input);
            i = 0;
            while (i < length) {
                if (counter[i] < i) {
                    swap(chars, i % 2 === 1 ? counter[i] : 0, i);
                    counter[i]++;
                    i = 0;

                    const word = chars.join("");

                    if (!cache.includes(word)) {
                        anagrams.push(word);
                        cache.push(word);
                    } else removedWords += 1;
                } else {
                    counter[i] = 0;
                    i++;
                }
            }

            return [anagrams, removedWords];
        }

        function removeNonMatchingElements(list) {
            return list.filter((element) => {
                const lastChar = element[element.length - 1];
                return lastChar === 's' || lastChar === 'a' || lastChar === "ē" ||
                 lastChar === 'ī' || lastChar === "e" || lastChar === 'im' || lastChar === "iem";
            });
        }

        async function findInflections(word) {
            const response = await fetch(`https://api.tezaurs.lv/v1/inflections/${word}`);
            const json = await response.json();
            return json[0].map(entry => entry.Vārds); // Vārds stands for word
        }

        function removeLetter(word, time) {
            return word.replace(word[word.length-time], '');
        }

        function removeDuplicates(list) {
            var uniqueStrings = [];
            var duplicates = [];

            for (var i = 0; i < list.length; i++) {
                var currentItem = list[i];

                if (uniqueStrings.includes(currentItem)) {
                    duplicates.push(currentItem);
                } else {
                    uniqueStrings.push(currentItem);
                }
            }

            return uniqueStrings;
        }


        async function getword(l='', count, combinations, words, lorig=null, times=0, combi) {

            if (!combinations || combinations.length == 0) {
                // If no words generated generate them
                const res = getAnagrams(l);
                combinations = res[0];
                const removedWordCount = res[1];

                prevCombinationLen = combinations.length

                
                // remove duplications of words
                combinations = removeDuplicates(combinations)

                // Remove "words" we know that definetly aren't words
                combinations = removeNonMatchingElements(combinations);

                // Make sure the progress bar is displaying correctly
                const difference = prevCombinationLen-combinations.length
                combi = combi - difference - removedWordCount;

            }

            if (!words) words = [];

            let word = [];
            let found = false;
            while (!found) {
                if (count[1] == combi) {
                    document.getElementById('comp').innerHTML = "Done!";
                    return
                }

                // checking if the word exists
                word = await main(combinations[count[0]]);
                if (word.length > 1) found = true;

                word = combinations[count[0]];
                count[0]++;
                count[1]++;

                const prev = Math.floor(((count[1]-1)/combi)*100);
                const newPercentage = Math.floor(((count[1])/combi)*100);

                if (prev != newPercentage && newPercentage < 101) {
                    const comp = document.getElementById('comp');
                    comp.innerHTML = `(${newPercentage}%) Checking ${combinations.length} words`;
                }


                if (count[0] > combinations.length) {
                    // No more possible combinations
                    if (words.length != 0 && words.length == 1) { // Give other options
                        const locijumi = await findInflections(words[0]);
                    }
                    
                    // All combinations where used
                    // Trying again but removing a letter
                    if (!lorig) { // This is the first attempt on trying to remove a letter
                        setTimeout(function() {
                            const lett = l.slice(0, -1);
                            getword(lett, [0, count[1]], null, words, l, 1, combi);
                        }, 0);
                        return;
                    } else {
                        if (times == lorig.length) {
                            if (l.length > 3) {
                                getword(l, [0, count[1]], null, words, l, 0, combi)
                            }
                            return;
                        }
                        const lett = removeLetter(lorig, times);
                        times += 1;
                        getword(lett, [0, count[1]], null, words, lorig, times, combi);
                        return;
                    }
                }
            }
            // parbaudam vai jau tads vards ir
            if (!words.includes(word)){
                const result = document.getElementById('res');
                const btn = document.createElement('button');
                btn.textContent = word
                btn.v = word
                btn.onclick = async function() {
                    const locijumi = await findInflections(this.v)
                    const loc = document.getElementById('loc');
                    loc.innerHTML = "Inflections for word : "+locijumi.join(", ")
                }
                result.appendChild(btn)
                words.push(word);

                const atrastiv = document.getElementById('atrasti');
                atrastiv.innerHTML = "Found words: " + words.length
            }   

            // we continue to search for more words
            getword(l, count, combinations, words, lorig, times, combi);
        }



        async function search() {

            const val = document.getElementById('fname').value;
            const result = document.getElementById('res');

            result.innerHTML = "";
            if (val.length == 3) {
                return;
            }
            const comp = document.getElementById('comp');

            comp.innerHTML = '';

            let combinations = factorial(val.length) + (factorial(val.length-1) * (val.length-1));
            if (val.length > 3) combinations += + (factorial(val.length-2) * (val.length-2));

            comp.innerHTML = "Estimated words: "+combinations;

            const search = document.getElementById('search');

            search.style.display = "none";

            cache = []
            

            await getword(val, [0,0], null, null, null, null, combinations);
            search.style.display = "inline";
        }

        document.getElementById("search").addEventListener("click", search); 
    </script>
</body>
</html>